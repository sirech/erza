# -*- mode: Shell-script-*-
#!/usr/bin/env bash

echo '****** UPDATE ******'
repo=/srv/erza
app=$1

if [ ! -d ${repo} ] ; then
    echo 'configuration is not there'
    exit 1
fi

cd ${repo}

echo '*** Pulling latest changes from main repository ***'
git pull origin master || { echo 'ERROR: Could not pull from origin' ; exit 1; }
echo '*** Pulling latest changes from submodules ***'
repos=$(git submodule | awk '{ print $2 }')
for subm in $repos ; do
    echo "*** Pulling changes from ${subm} ***"
    pushd $subm
    git pull origin master || { echo "Error: Could not pull ${subm}" ; exit 1; }
    popd
done

echo '*** Pulling latest images ***'
docker-compose pull $app || { echo "ERROR: Could not pull images [$app]"; exit 1; }
echo '*** Starting images ***'
docker-compose up -d --build $app || { echo "ERROR: Could not start images [$app]"; exit 1; }
